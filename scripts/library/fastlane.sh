#!/bin/bash

# exit on failure
set -e

fastlane_integrate()
{
	fastlane_bootstrap
	fastlane_write
}

#
# Creates Fastlane folder and initializes basic
#

fastlane_bootstrap()
{
  FASTLANE_FOLDER=$(find_dir 'fastlane')

  if [ -d "$FASTLANE_FOLDER" ]; then
  	mkdir 'fastlane'

  	fastlane_write './fastlane'
  fi
}

#
# Write Fastlane file according to configuration
#

fastlane_write()
{
  FASTLANE_APPFILE=$(find_file 'appfile')
  FASTLANE_FASTFILE=$(find_file 'fastfile')

  if [[ ! -z $FASTLANE_APPFILE ]]; then
  	touch "$1/Appfile"
  	FASTLANE_APPFILE="$1/Appfile"
  else
  	# Move Fastlane App File
  fi

  fastlane_app_write $FASTLANE_APPFILE

  #
  # Fastfile
  #

  if [[ ! -z $FASTLANE_FASTFILE ]]; then
  	touch "$1/Appfile"

  	#
  	# Write app file
  	#
    
    FASTLANE_FASTFILE="$1/Fastfile"
  	
  else
  	# Move Fastlane App File
  fi

  fastlane_file_write $FASTLANE_FASTFILE
}

#
# Write fastlane Appfile with data
#
fastlane_app_write()
{
  echo '# Dominus: Autogenerated Appfile: '$SCRIPT_VERSION > $1

  if [[ ! -z $BUNDLE_IDENTIFIER ]]; then
    echo 'app_identifier "'$BUNDLE_IDENTIFIER'"' >> $1
  fi

  if [[ ! -z $APPLE_DEV_PORTAL_ID ]]; then
    echo 'apple_dev_portal_id "'$APPLE_DEV_PORTAL_ID'"' >> $1
  fi

  if [[ ! -z $ITUNES_CONNECT_ID ]]; then
  	echo 'itunes_connect_id "'$APPLE_DEV_PORTAL_ID'"' >> $1
  fi

  if [[ ! -z $APPLE_ID ]]; then
  	echo 'apple_id "'$APPLE_ID'"' >> $1
  fi

  if [[ ! -z $TEAM_ID ]]; then
  	echo 'team_id "'$TEAM_ID'"' >> $1
  fi
}

#
# Write fastlane Fastfile with data
#
fastlane_file_write()
{
  echo '# Dominus: Autogenerated Fastfile: '$SCRIPT_VERSION > $1

  #
  # Write current Fastlane version
  #

  FASTLANE_VERSION=$(fastlane_version)

  echo 'fastlane_version "'$FASTLANE_VERSION'"' >> $1

  #
  # Write platform, default to ios
  #

  echo 'default_platform :'$BUILD_PLATFORM >> $1
  echo '\n' >> $1

  #
  # Generate platform Fastlane
  #

  echo 'platform: '$BUILD_PLATFORM >> $1

  fastlane_create_before_all $1

  fastlane_create_lane 'build' $1
  fastlane_create_lane 'test' $1
  fastlane_create_lane 'deploy' $1

  fastlane_create_after_all $1
  fastlane_create_error $1

  echo 'end' >> $1
}

fastlane_create_lane()
{
  echo '  lane: '$1' do' >> $2

  if [ "$1" == "deploy" ]; then
    fastlane_create_deploy $2
  elif [ "$1" == "test" ]; then
  	fastlane_create_test $2
  elif [ "$1" == "build" ]; then
  	fastlane_create_build $2
  else
  	fastlane_create_build $2
  fi

  echo '  end' >> $2
}

fastlane_create_build()
{
  fastlane_cert
  fastlane_sigh
  fastlane_gym
}

fastlane_create_test()
{
  fastlane_scan
}

fastlane_create_deploy()
{
  fastlane_cert
  fastlane_sigh
  fastlane_scan
  fastlane_gym
  fastlane_deliver
}

fastlane_create_before_all()
{
  echo '  before_all do' >> $1

  echo '  end' >> $1
}

fastlane_create_after_all()
{
  echo '  before_all do |lane|' >> $1

  echo '  end' >> $1
}

fastlane_create_error()
{
  echo '  error do |lane, exception|' >> $1

  echo '  end' >> $1
}

fastlane_gym()
{

}

fastlane_scan()
{
  local SCAN_FILE=$(find_file 'Scanfile')

  if [[ ! -z $SCAN_FILE ]]; then
  	install_scan

  	set +e

  	`scan`

	  set -e

	  test_report

  	return
  fi
}

fastlane_deliver()
{

}

fastlane_cert()
{

}

fastlane_sigh()
{

}

fastlane_match()
{

}

#
# Runs fastlane on a specific lane
#

fastlane_execute()
{
	#
	# Do any extra preparation for running Fastlane (installing certificates)
	#
}

fastlane_version()
{
  local FASTLANE_VERSION=$(fastlane --version)
  FASTLANE_VERSION="${FASTLANE_VERSION#fastlane}"
  FASTLANE_VERSION=$(trim $FASTLANE_VERSION)
  echo $FASTLANE_VERSION
}